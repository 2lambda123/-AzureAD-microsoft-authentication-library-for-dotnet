# template-postbuild-code-analysis.yaml
# Run post-build code analysis (e.g. Roslyn analyzers)

steps:
- task: securedevelopmentteam.vss-secure-development-tools.build-task-roslynanalyzers.RoslynAnalyzers@3
  displayName: 'Run Roslyn Analyzers'
  inputs:
    userProvideBuildInfo: auto
    suppressionFileForCompilerWarnings: 'microsoft-authentication-library-for-dotnet\RoslynSuppressions.txt'
    msBuildCommandline: 'dotnet build'
    rulesetName: Recommended
    rulesetVersion: Latest
  env:
    system_accesstoken: $(System.AccessToken)
  continueOnError: true
  condition: and(succeeded(), eq(variables['PipelineType'], 'OneBranch'))

- task: VSBuild@1
  displayName: 'Rebuild solution for Roslyn workaround'
  inputs:
    solution: 'microsoft-authentication-library-for-dotnet/LibsAndSamples.sln'
    msbuildArgs: '/p:RunCodeAnalysis=false /p:MsalClientSemVer=${{ parameters.MsalClientSemVer }} /p:SourceLinkCreate=true /p:ContinousIntegrationBuild=true'
    platform: ${{ parameters.BuildPlatform }}
    configuration: ${{ parameters.BuildConfiguration }}
    maximumCpuCount: true

- task: securedevelopmentteam.vss-secure-development-tools.build-task-postanalysis.PostAnalysis@2
  displayName: 'Check Roslyn Results '
  inputs:
    GdnBreakGdnToolRoslynAnalyzers: true