
# Release builds are only manually triggered.
trigger: none
pr: none

# Create a daily midnight build for release builds on master to ensure our release builds function
schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - master

variables:
  BuildPlatform: 'any cpu'
  BuildConfiguration: 'release'

stages:
- stage: MSAL Release
  jobs: #Build and stage projects
  - job: 'BuildAndStageProjects'
    pool:
        vmImage: 'windows-latest'
        demands:
        - msbuild
        - visualstudio

    steps:
    # Run pre-build code analysis (policheck, credscan, etc)
    - template: template-prebuild-code-analysis.yaml

    # Unit tests require .NET 3.x
    - task: UseDotNet@2
      displayName: 'Use .Net Core SDK 3.x'
      inputs:
        version: 3.x
        
    # Use the latest .NET SDK
    - task: UseDotNet@2
      displayName: 'Use .Net Core sdk 5.x'
      inputs:
        version: 5.x

    # Bootstrap the build
    - template: template-build-and-prep-automation.yaml

    # BUILD IOS APPCENTER APP PHASE
  - job: 'BuildiOSAppCenterApp'
    pool:
        name: Azure Pipelines
        vmImage: macos-10.15

    steps:
    - template: template-build-ios-automation.yaml

    #Desktop Unit + Integration Tests
  - job: 'RunDesktopTests'
    dependsOn:
    - 'BuildAndStageProjects'
    pool:
        vmImage: 'windows-latest'
        demands:
        - msbuild
        - visualstudio

    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Drop'
      inputs:
        artifactName: drop
        itemPattern: '**/*'

    - task: CopyFiles@2
      displayName: 'Get MSAL tests'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)\drop\msalTests' 
        Contents: '**\*'
        TargetFolder: $(Build.SourcesDirectory)\tests\

    - task: CopyFiles@2
      displayName: 'Get MSAL Cache Compat'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)\drop\msalCacheTests' 
        Contents: '**\*'
        TargetFolder: $(Build.SourcesDirectory)\tests

      # Run All Desktop Tests
    - template: template-run-all-tests.yaml
      parameters:
        BuildConfiguration: '$(BuildConfiguration)'

# APP CENTER ANDROID MSAL TESTS PHASE

  - job: 'AppCenterAndroidMsalTests'
    dependsOn: 'BuildAndStageProjects'
    pool:
      vmImage: 'windows-latest'

    steps:
    - template: template-android-appcenter-tests.yaml

# APP CENTER IOS MSAL TESTS PHASE
  - job: 'AppCenterIosMsalTests'
    dependsOn:
    - 'BuildAndStageProjects'
    - 'BuildiOSAppCenterApp'
    pool:
      vmImage: 'windows-latest'

    steps:
    - template: template-ios-appcenter-tests.yaml

    # Pack and sign packages
  - job: 'PackAndSign'
    dependsOn:
    - 'BuildAndStageProjects'
    - 'AppCenterIosMsalTests'
    - 'RunDesktopTests'
    pool:
        vmImage: 'windows-latest'
        demands:
        - msbuild
        - visualstudio

    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'Download Drop'
      inputs:
        artifactName: drop
        itemPattern: '**/*'

    - task: CopyFiles@2
      displayName: 'Get MSAL src'
      inputs:
        SourceFolder: '$(build.artifactstagingdirectory)\drop\msalSrc'
        Contents: '**\*'
        TargetFolder: $(Build.SourcesDirectory)\src\client

    # Run Post-build code analysis (e.g. Roslyn)
    - template: template-postbuild-code-analysis.yaml

    # Pack and sign all of the nuget packages
    # Required for the signing task, but does not need to be used
    - task: UseDotNet@2
      displayName: 'Use .Net Core SDK 2.x'
      inputs:
        version: 2.x

    - template: template-pack-and-sign-all-nugets.yaml

    # Publish nuget packages and symbols to VSTS package manager.
    - template: template-publish-packages-and-symbols.yaml

    # Publish analysis and cleanup
    - template: template-publish-analysis-and-cleanup.yaml