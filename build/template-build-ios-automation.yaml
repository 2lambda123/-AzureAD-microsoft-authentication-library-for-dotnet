steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: BuildAutomation'
  inputs:
    azureSubscription: '.NET Keyvault'
    KeyVaultName: buildautomation
    SecretsFilter: AppCenterDotNetiOSTestCertPassword

- task: DownloadSecureFile@1
  displayName: 'Download Certificate'
  inputs:
    secureFile: AppCenteriOSBuildCert.p12

- task: DownloadSecureFile@1
  displayName: 'Download Provisioning Provile'
  inputs:
    secureFile: 'TestFile.mobileprovision'

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    restoreSolution: LibsMacOS.sln

- task: UseDotNet@2
  displayName: 'Use .Net Core sdk 5.x'
  inputs:
    version: 5.x

- task: InstallAppleCertificate@2
  inputs:
    certSecureFile: '$(Agent.TempDirectory)/AppCenteriOSBuildCert.p12'
    certPwd: '$(AppCenterDotNetiOSTestCertPassword)'
    
- task: InstallAppleProvisioningProfile@1
  inputs:
    provProfileSecureFile: '$(Agent.TempDirectory)/TestFile.mobileprovision'

- task: XamariniOS@2
  displayName: 'Build Xamarin.iOS solution LibsMacOS.sln'
  inputs:
    solutionFile: LibsMacOS.sln
    configuration: Debug
    clean: true
    runNugetRestore: false
    args: '/p:APPCENTER_BUILD=1 /p:RunCodeAnalysis=false'
    buildToolLocation: $(Agent.ToolsDirectory)/dotnet
    signingIdentity: '$(APPLE_CERTIFICATE_SIGNING_IDENTITY)'
    signingProvisioningProfileID: '$(APPLE_PROV_PROFILE_UUID)'

- task: CopyFiles@2
  displayName: 'Copy ipa to staging directory'
  inputs:
    SourceFolder: tests/devapps/XForms/XForms.iOS/bin/iPhone/Debug
    Contents: '**/*.ipa'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    CleanTargetFolder: true
    OverWrite: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: Xamarin.iOS'
  inputs:
    ArtifactName: Xamarin.iOS
