parameters:
  DataFileDirectory: 'Release'

jobs: #Build and stage projects

- job: 'PreBuildCheck'
  pool:
      vmImage: 'windows-2022'
      demands:
      - msbuild
      - visualstudio
  variables:
      runCodesignValidationInjection: false

  steps:
  #Pre build analysis
    - template: template-prebuild-code-analysis.yaml

- job: 'BuildAndStageProjects'
  pool:
      vmImage: 'windows-2022'
      demands:
      - msbuild
      - visualstudio

  steps:
  # Bootstrap the build
  - template: template-build-and-prep-automation.yaml

# Disabled because mono is unable to restore/build .NET 6 target in MSAL project
# BUILD IOS APPCENTER APP PHASE
#- job: 'BuildiOSAppCenterApp'
#  dependsOn:
#    - 'PreBuildCheck'
#  pool:
#      name: Azure Pipelines
#      vmImage: macos-latest
#  variables:
#      runCodesignValidationInjection: false

#  steps:
#  - template: template-build-ios-automation.yaml

  # BUILD ANDROID APPCENTER APP PHASE
- job: 'BuildAndroidAppCenterApp'
  dependsOn:
    - 'PreBuildCheck'
  pool:
      vmImage: 'windows-2022'
      demands:
      - msbuild
      - visualstudio
  variables:
      runCodesignValidationInjection: false

  steps:
  - template: template-build-android-automation.yaml

# BUILD AND RUN CACHE COMPAT TESTS
- job: 'BuildAndRunCacheCompatTests'
  dependsOn:
    - 'BuildAndStageProjects'
  pool:
      vmImage: 'windows-2022'
      demands:
      - msbuild
      - visualstudio
  variables:
      runCodesignValidationInjection: false

  steps:
  - template: template-cachecompat-automation.yaml
    parameters:
      BuildPlatform: '$(BuildPlatform)'
      BuildConfiguration: '$(BuildConfiguration)'
      BuildSolution: 'LibsAndSamples.sln'

  #Desktop Unit + Integration Tests
- job: 'RunDesktopTests'
  #strategy:
  #  parallel: 5
  dependsOn:
  - 'BuildAndStageProjects'
  pool:
      vmImage: 'windows-2022'
      demands:
      - msbuild
      - visualstudio
  variables:
      runCodesignValidationInjection: false

  steps:
  - template: template-desktop-unit-and-automation.yaml

# APP CENTER ANDROID MSAL TESTS PHASE
- job: 'RunAppCenterAndroidMsalTests'
  dependsOn: 
  - 'BuildAndStageProjects'
  - 'BuildAndroidAppCenterApp'
  pool:
    vmImage: 'windows-2022'
  variables:
    runCodesignValidationInjection: false

  steps:
  - template: template-android-appcenter-tests.yaml
    parameters:
      DataFileDirectory: ${{ parameters.DataFileDirectory }}

# APP CENTER IOS MSAL TESTS PHASE
# - job: 'RunAppCenterIosMsalTests'
#   dependsOn:
#   - 'BuildAndStageProjects'
#   - 'BuildiOSAppCenterApp'
#   pool:
#     vmImage: 'windows-2022'
#   variables:
#     runCodesignValidationInjection: false

#   steps:
#   - template: template-ios-appcenter-tests.yaml
#     parameters:
#       DataFileDirectory: ${{ parameters.DataFileDirectory }}
